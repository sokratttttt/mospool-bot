{% extends 'base.html' %}

{% block title %}–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç - üèä –ë–∞—Å—Å–µ–π–Ω—ã{% endblock %}
{% block page_title %}‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç{% endblock %}

{% block content %}
<form method="post" enctype="multipart/form-data" class="post-form">
    {% csrf_token %}

    <div class="form-grid">
        <!-- Main Content -->
        <div class="form-main">
            <div class="card">
                <div class="card-header">
                    <h3>–û—Å–Ω–æ–≤–Ω–æ–µ</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π)</label>
                        <input type="text" id="title" name="title" required placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞">
                    </div>

                    <div class="form-group">
                        <label for="content">–¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞</label>
                        <textarea id="content" name="content" rows="10" required
                            placeholder="–¢–µ–∫—Å—Ç –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏..."></textarea>
                        <div class="char-counter">
                            <span id="charCount">0</span> —Å–∏–º–≤–æ–ª–æ–≤
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="image">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                        <input type="file" id="image" name="image" accept="image/*">
                        <div id="imagePreview" class="image-preview"></div>
                    </div>
                </div>
            </div>

            <!-- AI Generation -->
            <div class="card">
                <div class="card-header">
                    <h3>ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å –ò–ò</h3>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label>–¢–∏–ø –±–∞—Å—Å–µ–π–Ω–∞</label>
                            <select id="ai_pool_type">
                                <option value="–±–µ—Ç–æ–Ω–Ω—ã–π">–ë–µ—Ç–æ–Ω–Ω—ã–π</option>
                                <option value="–∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π">–ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π</option>
                                <option value="–∫–∞—Ä–∫–∞—Å–Ω—ã–π">–ö–∞—Ä–∫–∞—Å–Ω—ã–π</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>–†–∞–∑–º–µ—Ä</label>
                            <input type="text" id="ai_size" placeholder="8x4 –º">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏</label>
                        <input type="text" id="ai_features" placeholder="–ü—Ä–æ—Ç–∏–≤–æ—Ç–æ–∫, –ø–æ–¥—Å–≤–µ—Ç–∫–∞, –¥–∂–∞–∫—É–∑–∏">
                    </div>
                    <button type="button" class="btn btn-secondary" onclick="generateWithAI()">
                        ü§ñ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="form-sidebar">
            <div class="card">
                <div class="card-header">
                    <h3>–ü—É–±–ª–∏–∫–∞—Ü–∏—è</h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select name="category">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                            {% for cat in categories %}
                            <option value="{{ cat.id }}">{{ cat.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>–ü–ª–∞—Ç—Ñ–æ—Ä–º—ã</label>
                        <div class="checkbox-group">
                            {% for platform in platforms %}
                            <label class="checkbox-label">
                                <input type="checkbox" name="platforms" value="{{ platform.id }}">
                                {% if platform.name == 'telegram' %}üì±{% else %}üí¨{% endif %}
                                {{ platform.display_name }}
                            </label>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="scheduled_time">–í—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</label>
                        <input type="datetime-local" id="scheduled_time" name="scheduled_time">
                    </div>

                    <div class="form-group">
                        <label>–°—Ç–∞—Ç—É—Å</label>
                        <select name="status">
                            <option value="draft">üìù –ß–µ—Ä–Ω–æ–≤–∏–∫</option>
                            <option value="pending">‚è≥ –ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é</option>
                            <option value="approved">‚úÖ –û–¥–æ–±—Ä–µ–Ω</option>
                        </select>
                    </div>
                </div>
                <div class="card-footer">
                    <button type="submit" class="btn btn-primary btn-block">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    // Character counter
    const contentField = document.getElementById('content');
    const charCount = document.getElementById('charCount');

    contentField.addEventListener('input', function () {
        charCount.textContent = this.value.length;
    });

    // Image preview
    const imageInput = document.getElementById('image');
    const imagePreview = document.getElementById('imagePreview');

    imageInput.addEventListener('change', function () {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function (e) {
                imagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
            };
            reader.readAsDataURL(this.files[0]);
        }
    });

    // AI Generation
    async function generateWithAI() {
        const poolType = document.getElementById('ai_pool_type').value;
        const size = document.getElementById('ai_size').value;
        const features = document.getElementById('ai_features').value;

        try {
            const response = await fetch('/api/generate/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    category: 'project',
                    pool_type: poolType,
                    size: size,
                    features: features,
                    use_ai: true
                })
            });

            const data = await response.json();
            if (data.success) {
                contentField.value = data.content;
                charCount.textContent = data.content.length;
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ' + error.message);
        }
    }
</script>
{% endblock %}