{% extends 'base.html' %}

{% block title %}–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ - üèä –ë–∞—Å—Å–µ–π–Ω—ã{% endblock %}
{% block page_title %}ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å –ò–ò{% endblock %}

{% block content %}
<div class="generate-page">
    <div class="generate-grid">
        <!-- Input Form -->
        <div class="card">
            <div class="card-header">
                <h3>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞</label>
                    <select id="category">
                        <option value="project">üèä –ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</option>
                        <option value="tip">üí° –ü–æ–ª–µ–∑–Ω—ã–π —Å–æ–≤–µ—Ç</option>
                        <option value="promo">üéÅ –ê–∫—Ü–∏—è</option>
                        <option value="case">üì∏ –ö–µ–π—Å</option>
                        <option value="edu">üìö –û–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã–π</option>
                    </select>
                </div>

                <div id="projectFields">
                    <div class="form-group">
                        <label>–¢–∏–ø –±–∞—Å—Å–µ–π–Ω–∞</label>
                        <select id="pool_type">
                            {% for value, label in pool_types %}
                            <option value="{{ label }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>–†–∞–∑–º–µ—Ä—ã</label>
                            <input type="text" id="size" placeholder="8x4 –º, –≥–ª—É–±–∏–Ω–∞ 1.5 –º">
                        </div>
                        <div class="form-group">
                            <label>–õ–æ–∫–∞—Ü–∏—è</label>
                            <input type="text" id="location" placeholder="–ú–æ—Å–∫–≤–∞ –∏ –ú–û">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏</label>
                        <textarea id="features" rows="3"
                            placeholder="–ü—Ä–æ—Ç–∏–≤–æ—Ç–æ–∫, RGB –ø–æ–¥—Å–≤–µ—Ç–∫–∞, –¥–∂–∞–∫—É–∑–∏ –∑–æ–Ω–∞, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ"></textarea>
                    </div>
                </div>

                <div id="tipFields" style="display: none;">
                    <div class="form-group">
                        <label>–¢–µ–º–∞ —Å–æ–≤–µ—Ç–∞</label>
                        <input type="text" id="tip_title" placeholder="–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä">
                    </div>
                    <div class="form-group">
                        <label>–ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</label>
                        <textarea id="tip_content" rows="3" placeholder="–û—Å–Ω–æ–≤–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã —Å–æ–≤–µ—Ç–∞..."></textarea>
                    </div>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="use_ai" checked>
                        –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DeepSeek AI (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)
                    </label>
                </div>

                <button type="button" class="btn btn-primary btn-block" onclick="generateContent()">
                    ü§ñ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç
                </button>
            </div>
        </div>

        <!-- Result -->
        <div class="card">
            <div class="card-header">
                <h3>–†–µ–∑—É–ª—å—Ç–∞—Ç</h3>
                <div class="header-actions">
                    <button type="button" class="btn btn-sm btn-secondary" onclick="copyToClipboard()">üìã
                        –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button type="button" class="btn btn-sm btn-primary" onclick="createPost()">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç</button>
                </div>
            </div>
            <div class="card-body">
                <div id="loadingIndicator" style="display: none;" class="loading">
                    <div class="spinner"></div>
                    <span>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...</span>
                </div>
                <textarea id="generatedContent" rows="15"
                    placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç..."></textarea>
                <div class="char-counter">
                    <span id="charCount">0</span> —Å–∏–º–≤–æ–ª–æ–≤
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Tips -->
    <div class="card">
        <div class="card-header">
            <h3>üí° –ë—ã—Å—Ç—Ä–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–æ–≤–µ—Ç–æ–≤</h3>
        </div>
        <div class="card-body">
            <p>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≥–æ—Ç–æ–≤—ã—Ö —Å–æ–≤–µ—Ç–æ–≤ –ø–æ —É—Ö–æ–¥—É –∑–∞ –±–∞—Å—Å–µ–π–Ω–æ–º:</p>
            <div class="quick-tips">
                <button class="btn btn-outline" onclick="generateTip('–ß–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞')">üîß –ß–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞</button>
                <button class="btn btn-outline" onclick="generateTip('–ü—Ä–æ–≤–µ—Ä–∫–∞ pH')">‚öóÔ∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ pH</button>
                <button class="btn btn-outline" onclick="generateTip('–ó–∏–º–Ω—è—è –∫–æ–Ω—Å–µ—Ä–≤–∞—Ü–∏—è')">‚ùÑÔ∏è –ö–æ–Ω—Å–µ—Ä–≤–∞—Ü–∏—è</button>
                <button class="btn btn-outline" onclick="generateTip('–£—Ä–æ–≤–µ–Ω—å —Ö–ª–æ—Ä–∞')">üíß –£—Ä–æ–≤–µ–Ω—å —Ö–ª–æ—Ä–∞</button>
                <button class="btn btn-outline" onclick="generateTip('–û–±—Ä–∞—Ç–Ω–∞—è –ø—Ä–æ–º—ã–≤–∫–∞')">üîÑ –û–±—Ä–∞—Ç–Ω–∞—è –ø—Ä–æ–º—ã–≤–∫–∞</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const categorySelect = document.getElementById('category');
    const projectFields = document.getElementById('projectFields');
    const tipFields = document.getElementById('tipFields');
    const generatedContent = document.getElementById('generatedContent');
    const charCount = document.getElementById('charCount');
    const loadingIndicator = document.getElementById('loadingIndicator');

    // Toggle fields based on category
    categorySelect.addEventListener('change', function () {
        if (this.value === 'tip') {
            projectFields.style.display = 'none';
            tipFields.style.display = 'block';
        } else {
            projectFields.style.display = 'block';
            tipFields.style.display = 'none';
        }
    });

    // Update char count
    generatedContent.addEventListener('input', function () {
        charCount.textContent = this.value.length;
    });

    async function generateContent() {
        const category = categorySelect.value;
        const useAi = document.getElementById('use_ai').checked;

        const data = {
            category: category,
            use_ai: useAi,
            pool_type: document.getElementById('pool_type').value,
            size: document.getElementById('size').value,
            features: document.getElementById('features').value,
            location: document.getElementById('location').value,
            title: document.getElementById('tip_title')?.value || '',
            content: document.getElementById('tip_content')?.value || '',
        };

        loadingIndicator.style.display = 'flex';
        generatedContent.value = '';

        try {
            const response = await fetch('/api/generate/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.success) {
                generatedContent.value = result.content;
                charCount.textContent = result.content.length;
            } else {
                generatedContent.value = '–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
            }
        } catch (error) {
            generatedContent.value = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message;
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }

    function generateTip(topic) {
        document.getElementById('category').value = 'tip';
        categorySelect.dispatchEvent(new Event('change'));
        document.getElementById('tip_title').value = topic;
        generateContent();
    }

    function copyToClipboard() {
        generatedContent.select();
        document.execCommand('copy');
        alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
    }

    function createPost() {
        const content = generatedContent.value;
        if (!content) {
            alert('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç');
            return;
        }

        // Redirect to create page with content in URL
        const url = new URL('{% url "post_create" %}', window.location.origin);
        sessionStorage.setItem('generatedContent', content);
        window.location.href = url;
    }

    // Load content from session if available
    window.addEventListener('load', function () {
        const saved = sessionStorage.getItem('generatedContent');
        if (saved && window.location.pathname.includes('create')) {
            document.getElementById('content').value = saved;
            sessionStorage.removeItem('generatedContent');
        }
    });
</script>
{% endblock %}